<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邪恶小团体大秘境统计</title>
    <link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif; /* 模拟 macOS 字体 */
    /* 柔和的浅灰色背景，模拟 macOS 的干净感 */
    background: #f8f8f8; /* 更浅的背景色 */
    min-height: 100vh;
    color: #333;
    line-height: 1.6;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* 淡淡的灰色阴影 */
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: white; /* 纯白色背景 */
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); /* 更柔和的阴影 */
}

.header h1 {
    font-size: 3.5em; /* 增大字体 */
    /* color: #2c3e50; */ /* 移除此行，让渐变色生效 */
    /* 移除背景剪裁和透明文本填充，以确保emoji正常显示 */
    /* background: linear-gradient(45deg, #4a4a4a, #2c2c2c); */
    /* -webkit-background-clip: text; */
    /* -webkit-text-fill-color: transparent; */
    /* background-clip: text; */
    color: #2c2c2c; /* 直接设置文本颜色为深灰色 */
}

.header p {
    color: #7f8c8d;
    font-size: 1.1em;
}

.section {
    background: white; /* 纯白色背景 */
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); /* 更柔和的阴影 */
}

.section h3 {
    color: #2c3e50;
    margin-bottom: 20px;
    border-bottom: 3px solid #888888; /* 灰色 */
    padding-bottom: 10px;
}

.table-container {
    overflow-x: auto;
    background: white; /* 添加背景色 */
    border-radius: 20px; /* 与其他卡片保持一致的圆角 */
    padding: 30px; /* 与其他卡片保持一致的内边距 */
    margin-bottom: 30px; /* 与其他卡片保持一致的下边距 */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); /* 与其他卡片保持一致的阴影 */
}

.table-wrapper {
    border-radius: 15px;
    overflow: auto;
    max-height: 600px; /* 设置最大高度，当内容超过时产生滚动 */
    /* 移除这里的box-shadow，因为已经添加到table-container */
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.summary-table th,
.summary-table td {
    padding: 15px 12px;
    text-align: center;
    border: 1px solid #e0e0e0;
    font-weight: 500;
}

.summary-table th {
    background: linear-gradient(45deg, #4a4a4a, #2c2c2c); /* 灰色渐变 */
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10; /* 提高z-index确保表头在最上层 */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 添加阴影让表头更明显 */
}

.summary-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.summary-table tr:hover {
    background-color: #e3f2fd;
    transition: background-color 0.3s ease;
}

/* 等级颜色样式 */
.level-empty {
    background-color: #DDDDDD !important;
    color: #4b5563;
}

.stats-grid {
    /* 移除 grid-template-columns，让其只作为容器 */
    display: block; /* 或者保持 grid，但移除列定义 */
    margin-bottom: 20px; /* 增加与下方内容的间距 */
}

/* 新增：角色统计控制区样式 */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 3px solid #888888; /* 灰色 */
    padding-bottom: 10px;
}

.section-header h3 {
    margin-bottom: 0; /* 覆盖默认的 margin-bottom */
    border-bottom: none; /* 覆盖默认的 border-bottom */
}

.character-stats-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* 手机端角色统计控制区域响应式布局 */
@media (max-width: 768px) {
    .section-header {
        flex-direction: column; /* 改为垂直排列 */
        align-items: flex-start; /* 左对齐 */
        gap: 15px; /* 增加元素间距 */
    }
    
    .character-stats-controls {
        flex-direction: column; /* 控制元素垂直排列 */
        align-items: flex-start; /* 左对齐 */
        gap: 10px; /* 减小元素间距 */
        width: 100%; /* 占满容器宽度 */
    }
    
    .character-stats-controls label {
        width: 100%; /* 标签占满宽度 */
        font-size: 0.9em; /* 稍微减小字体 */
    }
    
    .character-stats-controls select {
        width: 100%; /* 下拉框占满宽度 */
        padding: 10px 12px; /* 增加内边距便于点击 */
        font-size: 0.9em; /* 稍微减小字体 */
    }
    
    .character-stats-controls input[type="checkbox"] {
        width: 20px; /* 增大复选框便于点击 */
        height: 20px;
    }
}

.character-stats-controls label {
    display: flex;
    align-items: center;
    cursor: pointer;
    color: #333;
}

body.dark .character-stats-controls label {
    color: #e5e7eb;
}

.character-stats-controls input[type="checkbox"] {
    margin-right: 5px;
    width: 18px;
    height: 18px;
    accent-color: #4a4a4a; /* 深灰色 */
}

.character-stats-controls select {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    background-color: #fff;
    color: #333;
    font-size: 0.9em;
    cursor: pointer;
    outline: none;
    transition: border-color 0.3s ease;
}

body.dark .character-stats-controls select {
    background-color: #111827;
    border-color: #1f2937;
    color: #e5e7eb;
}

.character-stats-controls select:focus {
    border-color: #888888; /* 灰色 */
}

.stats-cards {
    display: grid;
    /* 调整 minmax，让卡片在不同屏幕下有更好的自适应性，并尝试更紧凑的布局 */
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    max-height: 600px; /* 设置最大高度 */
    overflow-y: auto; /* 垂直滚动 */
    padding-right: 10px; /* 避免滚动条遮挡内容 */
}

/* 通用卡片样式 (副本统计将使用此样式) */
.stat-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #e8e8e8;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: #d0d0d0;
}

.card-header {
    padding: 20px;
    border-left: 5px solid #888888;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dungeon-name {
    font-size: 1.2em;
    font-weight: 600;
    color: #2c3e50;
}

.card-content {
    padding: 20px;
}

.stat-item {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.stat-item .stat-label {
    flex-basis: 50%;
    text-align: left;
}

.stat-item .stat-value {
    flex-basis: 50%;
    text-align: right;
}

.stat-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.stat-label {
    color: #7f8c8d;
    font-weight: 500;
}

.stat-value {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1em;
}

/* 角色统计卡片样式 (新的独立样式) */
.character-stat-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* 增强阴影效果 */
    border: 1px solid #e8e8e8; /* 添加浅灰色边框 */
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    display: flex; /* 使卡片内部的header和content水平排列 */
    align-items: center; /* 垂直居中对齐 */
    padding: 0; /* 移除卡片本身的内边距，由内部元素控制 */
}

.character-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* 增强hover阴影效果 */
    border-color: #d0d0d0; /* hover时边框颜色加深 */
}

.character-card-header {
    padding: 15px 20px; /* 调整内边距 */
    border-left: 5px solid #888888; /* 灰色 */
    border-bottom: none; /* 移除底部边框 */
    display: flex;
    flex-direction: column; /* 使内部元素垂直排列 */
    justify-content: center; /* 垂直居中 */
    align-items: flex-start; /* 左对齐 */
    flex-shrink: 0; /* 不允许收缩 */
    width: 180px; /* 固定左侧宽度 */
    height: 100%; /* 填充高度 */
    position: relative; /* 用于定位职业 */
}

.character-info {
    /* flex: 1; */ /* 移除flex:1，因为card-header是column布局 */
    margin-bottom: 8px; /* 增加与职业之间的间距 */
}

.character-name {
    font-size: 1.1em; /* 稍微减小字体 */
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 3px; /* 减小与服务器之间的间距 */
}

.character-server {
    color: #7f8c8d;
    font-size: 0.8em; /* 稍微减小字体 */
}

.character-class {
    font-weight: 600;
    font-size: 1em; /* 稍微减小字体 */
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* 更明显的灰色阴影 */
    /* 确保职业在card-header的底部 */
    margin-top: auto; /* 将职业推到底部 */
}

.character-card-content {
    padding: 15px; /* 稍微减小内边距 */
    flex-grow: 1; /* 占据剩余空间 */
    display: flex; /* 使内部stat-row水平排列 */
    align-items: center; /* 垂直居中 */
    justify-content: center; /* 水平居中 */
}

.character-stat-row {
    display: flex;
    justify-content: space-around; /* 均匀分布项目 */
    align-items: flex-start; /* 顶部对齐 */
    flex-wrap: nowrap; /* 不允许换行，保持单行 */
    gap: 15px; /* 项目之间的间距 */
    width: 100%; /* 确保占据card-content的全部宽度 */
}

.character-stat-item {
    display: flex;
    flex-direction: column; /* 标签和值垂直排列 */
    align-items: center; /* 居中对齐 */
    flex: 1; /* 允许项目弹性伸缩 */
    min-width: 80px; /* 确保每个项目有最小宽度 */
    padding: 5px;
}

.character-stat-label {
    color: #7f8c8d;
    font-weight: 500;
    font-size: 0.9em; /* 稍微减小标签字体 */
    white-space: nowrap; /* 防止标签换行 */
}

.character-stat-value {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1em; /* 稍微减小值字体 */
    margin-top: 5px; /* 标签和值之间的间距 */
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.chart-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

.chart-card h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.2em;
    text-align: center;
}

.chart-container {
    position: relative;
    height: 280px; /* 默认高度稍微减小 */
}

/* 针对玩家统计图表，移除固定高度，让其在JS中动态计算 */
#playerChart {
    /* height: 400px; */ /* 移除固定高度 */
}

/* 手机端玩家统计图表优化 */
@media (max-width: 768px) {
    /* 玩家统计图表容器在手机端的高度限制 - 整体缩小 */
    .chart-card:has(#playerChart) {
        max-height: none; /* 移除最大高度限制 */
        overflow: visible; /* 允许内容溢出，由JS控制滚动 */
        margin-bottom: 10px;
    }
    
    #playerChart {
        /* height: 230px !important; */ /* 移除固定高度 */
        /* min-height: 230px !important; */ /* 移除最小高度 */
    }
    
    /* 在手机端隐藏玩家统计图表的图例 */
    .chart-card:has(#playerChart) canvas + .chartjs-legend {
        display: none !important;
    }
    
    /* 在手机端隐藏玩家统计图表的标题 "👑 玩家表现" */
    .chart-card:has(#playerChart) h4 {
        display: none !important;
    }
    
    /* 减少图表卡片的内边距，为图表提供更多空间 */
    .chart-card:has(#playerChart) {
        padding: 8px !important;
    }
}

.footer {
    text-align: center;
    padding: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 2em;
    }
    
    .stats-cards {
        grid-template-columns: 1fr;
    }
    
    .table-wrapper {
        overflow-x: auto; /* 确保在手机端表格可以水平滚动 */
    }
    
    .charts-container {
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    
    .chart-card {
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .chart-card h4 {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    
    .chart-container {
        height: 250px; /* 手机端进一步减小图表高度 */
    }
    
    /* 数据可视化板块的三个图表特殊优化 */
    .section:has(.charts-container) .chart-container {
        height: 280px; /* 数据可视化板块的图表高度，确保横坐标可见 */
    }
    
    /* 数据可视化板块的图表卡片在手机端居中 */
    .section:has(.charts-container) .chart-card {
        margin: 0 auto;
        max-width: 95%; /* 增加最大宽度，确保横坐标标签能够完整显示 */
        min-width: 320px; /* 设置最小宽度，确保图表有足够空间显示横坐标 */
    }
    
    .summary-table th,
    .summary-table td {
        padding: 8px 6px;
        font-size: 0.9em;
    }
}

/* KPI Cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}
.kpi-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05); /* 更柔和的阴影 */
    text-align: center;
}
.kpi-label {
    color: #6b7280;
    font-size: 1.2em; /* 增大字体 */
}
.kpi-value {
    color: #111827;
    font-size: 2.5em; /* 增大字体 */
    font-weight: 700;
    margin-top: 6px;
}

/* 新增：工具栏与按钮样式 */
.header-row {
    display: flex;
    align-items: center;
    justify-content: center; /* 居中对齐 */
    gap: 12px;
    margin-bottom: 6px;
}
.header-actions { display: flex; gap: 8px; }
.btn {
    background: #f0f0f0; /* 更简洁的背景色 */
    color: #374151;
    border: 1px solid #e0e0e0; /* 更简洁的边框 */
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: .2s ease;
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.08); }

.table-wrapper { overflow: auto; }
.table-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin: 10px 0 8px;
}
.toolbar-actions { display: flex; gap: 8px; }
.search-input {
    width: 260px;
    background: #fff;
    color: #111827;
    border: 1px solid #e0e0e0; /* 更简洁的边框 */
    border-radius: 10px;
    padding: 8px 12px;
    outline: none;
}
.search-input::placeholder { color: #9ca3af; }

/* 在手机端优化搜索框和按钮的布局 */
@media (max-width: 768px) {
    .search-input {
        width: 180px; /* 减小搜索框宽度 */
        padding: 6px 8px; /* 减小内边距 */
        font-size: 0.9em; /* 稍微减小字体 */
    }
    
    .table-toolbar {
        flex-direction: column; /* 改为垂直布局 */
        align-items: stretch; /* 让子元素占满宽度 */
        gap: 8px; /* 减小间距 */
    }
    
    .toolbar-actions {
        justify-content: space-between; /* 搜索框和清除按钮两端对齐 */
        width: 100%; /* 占满容器宽度 */
    }
    
    .btn {
        padding: 6px 10px; /* 减小按钮内边距 */
        font-size: 0.9em; /* 减小按钮字体 */
    }
}

/* 新增：冻结前两列与可排序样式 */
.sticky-col { position: sticky; background: white; z-index: 5; }
.sticky-col-1 { left: 0; }
.sticky-col-2 { left: 140px; z-index: 6; }

/* 确保表头的z-index高于固定列 */
.summary-table th.sticky-col {
    z-index: 15; /* 表头且固定列，最高优先级 */
}
.summary-table th:nth-child(1), .summary-table td:nth-child(1) { min-width: 140px; width: 140px; text-align: left; padding-left: 14px; }
.summary-table th:nth-child(2), .summary-table td:nth-child(2) { min-width: 160px; width: 160px; text-align: left; padding-left: 14px; }
.summary-table th.sortable { cursor: pointer; position: sticky; top: 0; }
.summary-table th.sortable[data-sort="asc"]::after { content: " ▲"; font-size: 12px; }
.summary-table th.sortable[data-sort="desc"]::after { content: " ▼"; font-size: 12px; }

/* 在手机端，禁用固定列，让整个表格都可以水平滚动 */
@media (max-width: 768px) {
    .sticky-col {
        position: static; /* 移除固定定位 */
        background: white; /* 保持背景色 */
        z-index: auto; /* 重置z-index */
    }
    
    .sticky-col-1 {
        left: auto; /* 移除左偏移 */
    }
    
    .sticky-col-2 {
        left: auto; /* 移除左偏移 */
        z-index: auto; /* 重置z-index */
    }
    
    /* 在手机端减小列的宽度，让更多内容可见 */
    .summary-table th:nth-child(1), .summary-table td:nth-child(1) { 
        min-width: 100px; 
        width: 100px; 
        text-align: left; 
        padding-left: 8px; 
        font-size: 0.8em; /* 减小字体 */
    }
    
    .summary-table th:nth-child(2), .summary-table td:nth-child(2) { 
        min-width: 120px; 
        width: 120px; 
        text-align: left; 
        padding-left: 8px; 
        font-size: 0.8em; /* 减小字体 */
    }
    
    /* 为所有列设置更紧凑的样式 */
    .summary-table th, .summary-table td {
        min-width: 60px; /* 最小宽度 */
        padding: 6px 4px; /* 减小内边距 */
        font-size: 0.8em; /* 减小字体 */
        white-space: nowrap; /* 防止文字换行 */
    }
    
    /* 表头仍然保持固定在顶部 */
    .summary-table th {
        position: sticky;
        top: 0;
        z-index: 1;
    }
}

/* 职业图标 */
.character-class::before {
    margin-right: 5px;
    font-size: 1.1em; /* 调整大小以匹配文本 */
    vertical-align: middle; /* 垂直居中 */
}

.class-死亡骑士::before { content: "💀"; }
.class-恶魔猎手::before { content: "👿"; }
.class-德鲁伊::before { content: "🐻"; }
.class-猎人::before { content: "🏹"; }
.class-法师::before { content: "🧙"; }
.class-武僧::before { content: "🥋"; }
.class-圣骑士::before { content: "🛡️"; }
.class-牧师::before { content: "😇"; }
.class-盗贼::before { content: "🔪" !important; }
.class-萨满祭司::before { content: "⚡"; }
.class-术士::before { content: "😈"; }
.class-战士::before { content: "⚔️"; }

/* Modal Styles */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1000; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
    backdrop-filter: blur(5px); /* 毛玻璃效果 */
    align-items: center; /* Center vertically */
    justify-content: center; /* Center horizontally */
}

.modal-content {
    background-color: #fefefe;
    margin: auto; /* Removed for flexbox centering */
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    position: relative;
    width: 90%; /* Adjust width as needed */
    max-width: 800px; /* Max width for larger screens */
    max-height: 90vh; /* Max height to prevent overflow */
    overflow-y: auto; /* Enable scrolling for content if needed */
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.close-button {
    color: #aaa;
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 36px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close-button:hover,
.close-button:focus {
    color: #333;
    text-decoration: none;
}

.modal-title {
    font-size: 2em;
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: center;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}

.modal-body {
    position: relative;
    height: 400px; /* Chart height inside modal */
    width: 100%;
}

/* Responsive adjustments for modal */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        padding: 20px;
    }
    .modal-title {
        font-size: 1.5em;
    }
    .close-button {
        font-size: 30px;
        top: 10px;
        right: 20px;
    }
    .modal-body {
        height: 300px; /* Adjust chart height for smaller screens */
    }
}

/* AFK Icon and Modal Specific Styles */
.afk-icon-container {
    position: relative; /* 改为相对定位 */
    display: inline-block; /* 作为内联块元素 */
    cursor: pointer;
    font-size: 1.5em; /* 图标大小 */
    color: #e74c3c; /* 红色心形 */
    transition: transform 0.2s ease-in-out;
    margin-top: 10px; /* 与标题的间距 */
}

.afk-icon-container:hover {
    transform: scale(1.1); /* 鼠标悬停放大效果 */
}

.afk-icon-text {
    font-size: 0.7em; /* 调整字体大小 */
    color: #555; /* 调整颜色 */
    margin-left: 5px; /* 与爱心图标的间距 */
    vertical-align: middle; /* 垂直对齐 */
}

/* 在手机端，让爱心emoji独立显示在标题下方 */
@media (max-width: 768px) {
    .header-row {
        flex-direction: column; /* 改为垂直排列 */
        align-items: center; /* 居中对齐 */
        gap: 10px; /* 元素间距 */
    }
    
    .afk-icon-container {
        position: relative; /* 确保在手机端也是相对定位 */
        right: auto; /* 移除右边距 */
        top: auto; /* 移除顶部定位 */
        transform: none; /* 移除变换 */
        margin-top: 15px; /* 增加与标题的间距 */
        font-size: 1.8em; /* 在手机端稍微增大图标 */
    }
    
    .afk-icon-text {
        font-size: 0.8em; /* 在手机端调整文字大小 */
    }
}

#afkPlayerModal .modal-content {
    max-width: 500px; /* AFK弹窗的宽度 */
    text-align: center;
}

.afk-player-list {
    max-height: 300px; /* 列表最大高度 */
    overflow-y: auto; /* 列表可滚动 */
    margin-top: 20px;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 10px;
    background-color: #f9f9f9;
}

.afk-player-name {
    padding: 8px 12px;
    margin: 5px 0;
    background-color: #fff;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
    font-size: 1.1em;
    color: #3498db; /* 蓝色文字 */
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.afk-player-name:hover {
    background-color: #eaf2f8;
    transform: translateY(-2px);
}

/* Emoji Fade Out Effect */
.emoji-fade-out {
    position: absolute;
    font-size: 3em;
    opacity: 1;
    pointer-events: none; /* Allow clicks to pass through */
    animation: fadeOutUp 1s forwards;
    z-index: 1001; /* Ensure it's above other elements */
}

@keyframes fadeOutUp {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    to {
        opacity: 0;
        transform: translateY(-50px) scale(1.5);
    }
}

/* Love Progress Bar */
.love-progress-container {
    width: 80%;
    background-color: #eee;
    border-radius: 10px;
    margin: 20px auto 10px;
    height: 20px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.love-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(to right, #ff7e5f, #feb47b); /* 暖色渐变 */
    border-radius: 10px;
    transition: width 0.3s ease-in-out;
}

#loveCount {
    font-size: 1.2em;
    font-weight: bold;
    color: #555;
}

/* Emoji Rain Effect */
#emojiRainContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 999; /* Below modals */
}

.falling-emoji {
    position: absolute;
    font-size: 2em;
    animation: fall linear infinite;
    opacity: 0;
}

@keyframes fall {
    0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
    }
}

/* New styles for individual player progress bars */
.afk-player-item {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Distribute items with space between */
    padding: 10px 15px;
    margin-bottom: 8px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}

.afk-player-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.afk-player-item .afk-player-name {
    flex-grow: 1; /* Allow name to take available space */
    text-align: left;
    font-size: 1.1em;
    font-weight: 600;
    color: #2c3e50; /* Darker color for name */
    margin-right: 10px; /* Space between name and progress bar */
    padding: 0; /* Override previous padding */
    box-shadow: none; /* Override previous box-shadow */
}

.player-progress-bar-container {
    width: 120px; /* Fixed width for individual progress bar */
    height: 12px;
    background-color: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
    margin-right: 10px; /* Space between progress bar and count */
}

.player-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(to right, #a8e063, #56ab2f); /* Greenish gradient for individual progress */
    border-radius: 6px;
    transition: width 0.3s ease-in-out;
}

.player-clicks-count {
    font-size: 0.9em;
    font-weight: bold;
    color: #7f8c8d;
    min-width: 40px; /* Ensure enough space for "10/10" */
    text-align: right;
}

/* 全屏按钮样式 */
.fullscreen-button-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
}

.fullscreen-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: linear-gradient(45deg, #4a4a4a, #2c2c2c);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1em;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.fullscreen-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    background: linear-gradient(45deg, #5a5a5a, #3a3a3a);
}

.fullscreen-icon {
    font-size: 1.2em;
}

.fullscreen-text {
    font-size: 1em;
}

/* 全屏表格弹窗样式 */
#fullscreenTableModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    overflow: hidden;
}

#fullscreenTableModal .modal-content {
    position: relative;
    width: 100%;
    height: 100%;
    background-color: #fff;
    margin: auto; /* 修改为 auto 以实现居中 */
    border-radius: 0;
    padding: 0;
    box-shadow: none;
    display: flex;
    flex-direction: column;
}

#fullscreenTableModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(45deg, #4a4a4a, #2c2c2c);
    color: white;
    border-bottom: 1px solid #333;
}

#fullscreenTableModal .modal-title {
    font-size: 1.5em;
    font-weight: 600;
    margin: 0;
}

#fullscreenTableModal .close-button {
    color: white;
    font-size: 30px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 5px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

#fullscreenTableModal .close-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

#fullscreenTableModal .modal-body {
    flex: 1;
    overflow: auto;
    padding: 0;
    background-color: #fff;
}

#fullscreenTableModal .table-wrapper {
    border-radius: 0;
    overflow: visible;
}

#fullscreenTableModal .summary-table {
    border-collapse: collapse;
    width: 100%;
    background: white;
}

#fullscreenTableModal .summary-table th,
#fullscreenTableModal .summary-table td {
    padding: 12px 10px;
    text-align: center;
    border: 1px solid #ddd;
    font-weight: 500;
    white-space: nowrap;
}

#fullscreenTableModal .summary-table th {
    background: linear-gradient(45deg, #4a4a4a, #2c2c2c);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

#fullscreenTableModal .summary-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

#fullscreenTableModal .summary-table tr:hover {
    background-color: #e3f2fd;
    transition: background-color 0.3s ease;
}

/* 在全屏模式下禁用固定列 */
#fullscreenTableModal .sticky-col {
    position: static;
    background: white;
    z-index: auto;
}

#fullscreenTableModal .sticky-col-1,
#fullscreenTableModal .sticky-col-2 {
    left: auto;
}

/* 手机端全屏弹窗样式 - 横屏优化 */
@media (max-width: 768px) and (orientation: landscape) {
    #fullscreenTableModal .modal-header {
        padding: 10px 15px;
    }
    
    #fullscreenTableModal .modal-title {
        font-size: 1.2em;
    }
    
    #fullscreenTableModal .close-button {
        font-size: 24px;
    }
    
    #fullscreenTableModal .summary-table th,
    #fullscreenTableModal .summary-table td {
        padding: 8px 6px;
        font-size: 0.8em;
    }
    
    /* 在手机端横屏模式下，减小列宽 */
    #fullscreenTableModal .summary-table th:nth-child(1),
    #fullscreenTableModal .summary-table td:nth-child(1) {
        min-width: 80px;
        width: 80px;
    }
    
    #fullscreenTableModal .summary-table th:nth-child(2),
    #fullscreenTableModal .summary-table td:nth-child(2) {
        min-width: 100px;
        width: 100px;
    }
    
    #fullscreenTableModal .summary-table th,
    #fullscreenTableModal .summary-table td {
        min-width: 50px;
    }
}

/* 手机端全屏按钮样式优化 */
@media (max-width: 768px) {
    .fullscreen-btn {
        padding: 8px 16px;
        font-size: 0.9em;
    }
    
    .fullscreen-icon {
        font-size: 1em;
    }
    
    .fullscreen-text {
        font-size: 0.9em;
    }
}

        .level-2 {
            background-color: #E3F2FD !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-3 {
            background-color: #BBDEFB !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-4 {
            background-color: #81D4FA !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-5 {
            background-color: #4DD0E1 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-6 {
            background-color: #4DB6AC !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-7 {
            background-color: #81C784 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-8 {
            background-color: #AED581 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-9 {
            background-color: #DCE775 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-10 {
            background-color: #FFF176 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-11 {
            background-color: #FFD54F !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-12 {
            background-color: #FFB74D !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-13 {
            background-color: #FF8A65 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-14 {
            background-color: #F48FB1 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-15 {
            background-color: #F06292 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-16 {
            background-color: #EC407A !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-17 {
            background-color: #E91E63 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-18 {
            background-color: #F44336 !important;
            color: #1f2937;
            font-weight: bold;
        }
        

        .level-19 {
            background-color: #D32F2F !important;
            color: #1f2937;
            font-weight: bold;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-row">
                <h1>😈 邪恶小团体大秘境统计</h1>
                <div class="afk-icon-container">
                    <span id="afk-icon" title="拯救AFK玩家">❤️</span>
                    <span class="afk-icon-text">点我试试</span>
                </div>
            </div>
            <p>生成时间: 2025-09-09 03:32:14</p>
        </div>

        <div class="section">
            
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">📊 总运行数</div>
                <div class="kpi-value">52</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">👥 角色数量</div>
                <div class="kpi-value">7</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">⏱️ 8本通关率</div>
                <div class="kpi-value">90.4%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">📈 平均层数</div>
                <div class="kpi-value">10.7</div>
            </div>
        </div>
        
        </div>

        <div class="section">
            <div class="section-header">
                <h3>📋 限时总览</h3>
                <div class="summary-table-controls">
                    <label for="hideUntimedSummaryRows">
                        <input type="checkbox" id="hideUntimedSummaryRows" checked> 隐藏无限时记录
                    </label>
                </div>
            </div>
            <div class="table-wrapper">
                
        <div class="table-container">
            <div class="table-toolbar">
                <div class="toolbar-actions">
                    <input id="summarySearch" class="search-input" type="search" placeholder="搜索玩家/角色/副本..." />
                    <button id="clearSearch" class="btn">清除</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="summaryTable" class="summary-table">
                    <thead>
                        <tr>
                            <th class="sticky-col sticky-col-1 sortable" data-type="text">👤 玩家</th>
                            <th class="sticky-col sticky-col-2 sortable" data-type="text">🎮 角色名</th>
        <th class="sortable" data-type="level" title="艾拉-卡拉，回响之城">回响</th><th class="sortable" data-type="level" title="奥尔达尼生态圆顶">圆顶</th><th class="sortable" data-type="level" title="赎罪大厅">赎罪</th><th class="sortable" data-type="level" title="水闸行动">水闸</th><th class="sortable" data-type="level" title="圣焰隐修院">隐修院</th><th class="sortable" data-type="level" title="塔扎维什: 索·莉亚的宏图">宏图</th><th class="sortable" data-type="level" title="塔扎维什: 琳彩天街">天街</th><th class="sortable" data-type="level" title="破晨号">破船</th>
                        </tr>
                    </thead>
                    <tbody>
        
                        <tr>
                            <td class="sticky-col sticky-col-1">亮仔</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(255, 125, 10, 0.1);">嘭地一声</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">亮仔</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(163, 48, 201, 0.1);">邪能肖战</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">吴工</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(199, 156, 110, 0.1);">体育老师</td>
            <td class="level-10" title="艾拉-卡拉，回响之城">+10</td><td class="level-10" title="奥尔达尼生态圆顶">+10</td><td class="level-10" title="赎罪大厅">+10</td><td class="level-10" title="水闸行动">+10</td><td class="level-8" title="圣焰隐修院">+8*</td><td class="level-11" title="塔扎维什: 索·莉亚的宏图">+11</td><td class="level-7" title="塔扎维什: 琳彩天街">+7</td><td class="level-9" title="破晨号">+9</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">吴工</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(245, 140, 186, 0.1);">邀月</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">吴工</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(196, 31, 59, 0.1);">黑魔仙豹哥</td>
            <td class="level-12" title="艾拉-卡拉，回响之城">+12</td><td class="level-13" title="奥尔达尼生态圆顶">+13</td><td class="level-12" title="赎罪大厅">+12</td><td class="level-12" title="水闸行动">+12</td><td class="level-13" title="圣焰隐修院">+13</td><td class="level-12" title="塔扎维什: 索·莉亚的宏图">+12</td><td class="level-13" title="塔扎维什: 琳彩天街">+13</td><td class="level-12" title="破晨号">+12</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">段总</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(255, 245, 105, 0.1);">生锈的斩牛刀</td>
            <td class="level-12" title="艾拉-卡拉，回响之城">+12</td><td class="level-13" title="奥尔达尼生态圆顶">+13</td><td class="level-14" title="赎罪大厅">+14*</td><td class="level-13" title="水闸行动">+13</td><td class="level-13" title="圣焰隐修院">+13</td><td class="level-13" title="塔扎维什: 索·莉亚的宏图">+13</td><td class="level-13" title="塔扎维什: 琳彩天街">+13</td><td class="level-13" title="破晨号">+13</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">段总</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(196, 31, 59, 0.1);">飞翔的潼瑜</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">舒总</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(105, 204, 240, 0.1);">Fountine</td>
            <td class="level-10" title="艾拉-卡拉，回响之城">+10*</td><td class="level-11" title="奥尔达尼生态圆顶">+11</td><td class="level-10" title="赎罪大厅">+10</td><td class="level-10" title="水闸行动">+10</td><td class="level-10" title="圣焰隐修院">+10</td><td class="level-11" title="塔扎维什: 索·莉亚的宏图">+11</td><td class="level-10" title="塔扎维什: 琳彩天街">+10</td><td class="level-11" title="破晨号">+11</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">舒总</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(196, 31, 59, 0.1);">天灵浴血</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">统皇</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(245, 140, 186, 0.1);">焦糖扁可颂</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">统皇</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(199, 156, 110, 0.1);">本间芽衣芓</td>
            <td class="level-10" title="艾拉-卡拉，回响之城">+10</td><td class="level-11" title="奥尔达尼生态圆顶">+11</td><td class="level-9" title="赎罪大厅">+9</td><td class="level-10" title="水闸行动">+10</td><td class="level-10" title="圣焰隐修院">+10</td><td class="level-11" title="塔扎维什: 索·莉亚的宏图">+11</td><td class="level-10" title="塔扎维什: 琳彩天街">+10</td><td class="level-11" title="破晨号">+11</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">巨奶</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(255, 255, 255, 0.1);">傻瓜观测</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">捷教授</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(105, 204, 240, 0.1);">四个自信</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">蔡圣</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(171, 212, 115, 0.1);">莱恩弗尔特</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-6" title="奥尔达尼生态圆顶">+6</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-6" title="水闸行动">+6</td><td class="level-9" title="圣焰隐修院">+9</td><td class="level-7" title="塔扎维什: 索·莉亚的宏图">+7*</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">蔡圣</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(255, 255, 255, 0.1);">亚妮艾丝</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">蔡圣</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(163, 48, 201, 0.1);">亚里欧斯</td>
            <td class="level-10" title="艾拉-卡拉，回响之城">+10*</td><td class="level-11" title="奥尔达尼生态圆顶">+11</td><td class="level-11" title="赎罪大厅">+11</td><td class="level-13" title="水闸行动">+13</td><td class="level-10" title="圣焰隐修院">+10</td><td class="level-10" title="塔扎维什: 索·莉亚的宏图">+10</td><td class="level-11" title="塔扎维什: 琳彩天街">+11</td><td class="level-10" title="破晨号">+10</td></tr>
                        <tr>
                            <td class="sticky-col sticky-col-1">元神</td>
                            <td class="sticky-col sticky-col-2" style="background-color: rgba(0, 112, 222, 0.1);">阿瘫</td>
            <td class="level-empty" title="艾拉-卡拉，回响之城">-</td><td class="level-empty" title="奥尔达尼生态圆顶">-</td><td class="level-empty" title="赎罪大厅">-</td><td class="level-empty" title="水闸行动">-</td><td class="level-empty" title="圣焰隐修院">-</td><td class="level-empty" title="塔扎维什: 索·莉亚的宏图">-</td><td class="level-empty" title="塔扎维什: 琳彩天街">-</td><td class="level-empty" title="破晨号">-</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
            </div>
            <div class="fullscreen-button-container">
                <button id="fullscreenTableBtn" class="btn fullscreen-btn">
                    <span class="fullscreen-icon">🔍</span>
                    <span class="fullscreen-text">全屏查看表格</span>
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h3>📈 玩家统计</h3>
            </div>
            <div class="charts-container">
                <div class="chart-card">
                    <h4>👑 玩家表现</h4>
                    <div class="chart-container">
                        <canvas id="playerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h3>🧙 角色统计</h3>
                <div class="character-stats-controls">
                    <label for="hideEmptyChars">
                        <input type="checkbox" id="hideEmptyChars" checked> 隐藏无记录角色
                    </label>
                    <select id="characterSortBy">
                        <option value="avg_level_desc">平均等级 (高到低)</option>
                        <option value="avg_level_asc">平均等级 (低到高)</option>
                        <option value="completion_rate_desc">通关率 (高到低)</option>
                        <option value="completion_rate_asc">通关率 (低到高)</option>
                        <option value="timed_runs_rate_desc">限时完成率 (高到低)</option>
                        <option value="timed_runs_rate_asc">限时完成率 (低到高)</option>
                        <option value="class_asc">职业 (A-Z)</option>
                        <option value="class_desc">职业 (Z-A)</option>
                        <option value="character_name_asc">角色名 (A-Z)</option>
                        <option value="character_name_desc">角色名 (Z-A)</option>
                    </select>
                </div>
            </div>
            <div class="stats-cards" id="characterStatsCards">
                <!-- Character stats will be rendered here by JS -->
            </div>
        </div>

        <div class="section">
            
        <div class="stats-grid">
            <h3>🗺️ 副本统计</h3>
            <div class="stats-cards">
        
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(255, 99, 132, 0.8);">
                        <div class="dungeon-name">艾拉-卡拉，回响之城</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.7</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">26:58</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">66.7%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(54, 162, 235, 0.8);">
                        <div class="dungeon-name">奥尔达尼生态圆顶</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.7</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">25:18</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">100.0%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(255, 206, 86, 0.8);">
                        <div class="dungeon-name">赎罪大厅</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">11.0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">29:08</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">83.3%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(75, 192, 192, 0.8);">
                        <div class="dungeon-name">水闸行动</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.6</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">26:06</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">100.0%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(153, 102, 255, 0.8);">
                        <div class="dungeon-name">圣焰隐修院</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.4</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">29:26</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">85.7%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(255, 159, 64, 0.8);">
                        <div class="dungeon-name">塔扎维什: 索·莉亚的宏图</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.7</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">25:03</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">85.7%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(199, 199, 199, 0.8);">
                        <div class="dungeon-name">塔扎维什: 琳彩天街</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">10.7</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">26:52</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">100.0%</span>
                        </div>
                    </div>
                </div>
            
                <div class="stat-card">
                    <div class="card-header" style="background-color: rgba(83, 102, 255, 0.8);">
                        <div class="dungeon-name">破晨号</div>
                    </div>
                    <div class="card-content">
                        <div class="stat-item">
                            <span class="stat-label">平均等级</span>
                            <span class="stat-value">11.0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均时间</span>
                            <span class="stat-value">24:38</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">通关率</span>
                            <span class="stat-value">100.0%</span>
                        </div>
                    </div>
                </div>
            
            </div>
        </div>
        
        </div>

        <div class="section">
            <h3>✨ 数据可视化</h3>
            <div class="charts-container">
                <div class="chart-card">
                    <h4>📊 等级分布</h4>
                    <div class="chart-container">
                        <canvas id="levelChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>⚔️ 副本表现</h4>
                    <div class="chart-container">
                        <canvas id="dungeonChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>🧑‍🤝‍🧑 职业平均层数</h4>
                    <div class="chart-container">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>由 Mythic Performance Tracker 自动生成</p>
    </div>

    <div id="playerDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle"></h2>
            <div class="modal-body">
                <canvas id="playerDetailChart"></canvas>
            </div>
        </div>
    </div>

    <!-- AFK Player Modal -->
    <div id="afkPlayerModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="afkCloseButton">&times;</span>
            <h2>拯救AFK玩家</h2>
            <div class="afk-player-list" id="afkPlayerList">
                <!-- AFK players will be loaded here -->
            </div>
            <div class="love-progress-container">
                <div class="love-progress-bar" id="loveProgressBar"></div>
                <span id="loveCount">0/10</span>
            </div>
        </div>
    </div>

    <!-- Fullscreen Table Modal -->
    <div id="fullscreenTableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">限时总览 - 全屏查看</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Table will be cloned here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Emoji Rain Container -->
    <div id="emojiRainContainer"></div>

    <script>
        const chartsData = {"level_distribution": {"labels": ["+6", "+7", "+8", "+9", "+10", "+11", "+12", "+13", "+14"], "data": [2, 2, 1, 3, 17, 10, 6, 10, 1]}, "class_performance": {"战士": {"avg_level": 9.8, "count": 16, "color": "#C79C6E"}, "死亡骑士": {"avg_level": 12.4, "count": 8, "color": "#C41F3B"}, "盗贼": {"avg_level": 13.0, "count": 8, "color": "#FFF569"}, "法师": {"avg_level": 10.4, "count": 8, "color": "#69CCF0"}, "猎人": {"avg_level": 7.0, "count": 4, "color": "#ABD473"}, "恶魔猎手": {"avg_level": 10.8, "count": 8, "color": "#A330C9"}}, "dungeon_performance": {"labels": ["回响", "圆顶", "赎罪", "水闸", "隐修院", "宏图", "天街", "破船"], "full_names": ["艾拉-卡拉，回响之城", "奥尔达尼生态圆顶", "赎罪大厅", "水闸行动", "圣焰隐修院", "塔扎维什: 索·莉亚的宏图", "塔扎维什: 琳彩天街", "破晨号"], "avg_levels": [10.7, 10.7, 11.0, 10.6, 10.4, 10.7, 10.7, 11.0], "timed_rates": [23.5, 41.2, 29.4, 41.2, 35.3, 35.3, 35.3, 35.3]}, "player_performance": {}, "character_stats_data": [{"player": "亮仔", "character": "嘭地一声", "server": "回音山", "class": "德鲁伊", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "亮仔", "character": "邪能肖战", "server": "回音山", "class": "恶魔猎手", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "吴工", "character": "体育老师", "server": "通灵学院", "class": "战士", "avg_level": 9.4, "timed_runs": 7, "total_runs": 8, "completion_rate": 87.5, "timed_runs_rate": 87.5}, {"player": "吴工", "character": "邀月", "server": "丽丽（四川）", "class": "骑士", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "吴工", "character": "黑魔仙豹哥", "server": "死亡之翼", "class": "死亡骑士", "avg_level": 12.4, "timed_runs": 8, "total_runs": 8, "completion_rate": 100.0, "timed_runs_rate": 100.0}, {"player": "段总", "character": "生锈的斩牛刀", "server": "伊森利恩", "class": "盗贼", "avg_level": 13.0, "timed_runs": 7, "total_runs": 8, "completion_rate": 87.5, "timed_runs_rate": 87.5}, {"player": "段总", "character": "飞翔的潼瑜", "server": "伊森利恩", "class": "死亡骑士", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "舒总", "character": "Fountine", "server": "图拉扬", "class": "法师", "avg_level": 10.4, "timed_runs": 7, "total_runs": 8, "completion_rate": 87.5, "timed_runs_rate": 87.5}, {"player": "舒总", "character": "天灵浴血", "server": "诺兹多姆", "class": "死亡骑士", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "统皇", "character": "焦糖扁可颂", "server": "斯坦索姆", "class": "骑士", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "统皇", "character": "本间芽衣芓", "server": "斯坦索姆", "class": "战士", "avg_level": 10.2, "timed_runs": 8, "total_runs": 8, "completion_rate": 100.0, "timed_runs_rate": 100.0}, {"player": "巨奶", "character": "傻瓜观测", "server": "影之哀伤", "class": "牧师", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "捷教授", "character": "四个自信", "server": "回音山", "class": "法师", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "蔡圣", "character": "莱恩弗尔特", "server": "神圣之歌", "class": "猎人", "avg_level": 7.0, "timed_runs": 3, "total_runs": 4, "completion_rate": 75.0, "timed_runs_rate": 75.0}, {"player": "蔡圣", "character": "亚妮艾丝", "server": "神圣之歌", "class": "牧师", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}, {"player": "蔡圣", "character": "亚里欧斯", "server": "神圣之歌", "class": "恶魔猎手", "avg_level": 10.8, "timed_runs": 7, "total_runs": 8, "completion_rate": 87.5, "timed_runs_rate": 87.5}, {"player": "元神", "character": "阿瘫", "server": "霜之哀伤", "class": "萨满", "avg_level": 0, "timed_runs": 0, "total_runs": 0, "completion_rate": 0, "timed_runs_rate": 0}], "CLASS_COLOR_MAP": {"死亡骑士": "C41F3B", "恶魔猎手": "A330C9", "德鲁伊": "FF7D0A", "猎人": "ABD473", "法师": "69CCF0", "武僧": "00FF96", "圣骑士": "F58CBA", "骑士": "F58CBA", "牧师": "FFFFFF", "潜行者": "FFF569", "盗贼": "FFF569", "萨满": "0070DE", "术士": "9482C9", "战士": "C79C6E"}, "LAYER_COLOR_MAP": {"2": "E3F2FD", "3": "BBDEFB", "4": "81D4FA", "5": "4DD0E1", "6": "4DB6AC", "7": "81C784", "8": "AED581", "9": "DCE775", "10": "FFF176", "11": "FFD54F", "12": "FFB74D", "13": "FF8A65", "14": "F48FB1", "15": "F06292", "16": "EC407A", "17": "E91E63", "18": "F44336", "19": "D32F2F"}, "DUNGEON_COLOR_MAP": {"艾拉-卡拉，回响之城": "rgba(255, 99, 132, 0.8)", "奥尔达尼生态圆顶": "rgba(54, 162, 235, 0.8)", "赎罪大厅": "rgba(255, 206, 86, 0.8)", "水闸行动": "rgba(75, 192, 192, 0.8)", "圣焰隐修院": "rgba(153, 102, 255, 0.8)", "塔扎维什: 索·莉亚的宏图": "rgba(255, 159, 64, 0.8)", "塔扎维什: 琳彩天街": "rgba(199, 199, 199, 0.8)", "破晨号": "rgba(83, 102, 255, 0.8)"}, "DUNGEON_FULL_NAME_MAP": {"回响": "艾拉-卡拉，回响之城", "圆顶": "奥尔达尼生态圆顶", "赎罪": "赎罪大厅", "水闸": "水闸行动", "隐修院": "圣焰隐修院", "宏图": "塔扎维什: 索·莉亚的宏图", "天街": "塔扎维什: 琳彩天街", "破船": "破晨号"}, "DUNGEON_SHORT_NAME_MAP": {"艾拉-卡拉，回响之城": "回响", "奥尔达尼生态圆顶": "圆顶", "赎罪大厅": "赎罪", "水闸行动": "水闸", "圣焰隐修院": "隐修院", "塔扎维什: 索·莉亚的宏图": "宏图", "塔扎维什: 琳彩天街": "天街", "破晨号": "破船"}, "player_stats_data": {"player_labels": ["段总", "吴工", "舒总", "统皇", "蔡圣"], "datasets": [{"label": "艾拉-卡拉，回响之城", "backgroundColor": "rgba(255, 99, 132, 0.8)", "borderColor": "rgba(255, 99, 132, 1)", "borderWidth": 1, "data": [1.5, 1.38, 1.25, 1.25, 0.83], "meta": {"avg_levels": [12.0, 11.0, 10.0, 10.0, 10.0], "runs": [1, 2, 1, 1, 1]}}, {"label": "奥尔达尼生态圆顶", "backgroundColor": "rgba(54, 162, 235, 0.8)", "borderColor": "rgba(54, 162, 235, 1)", "borderWidth": 1, "data": [1.62, 1.44, 1.38, 1.38, 1.42], "meta": {"avg_levels": [13.0, 11.5, 11.0, 11.0, 8.5], "runs": [1, 2, 1, 1, 2]}}, {"label": "赎罪大厅", "backgroundColor": "rgba(255, 206, 86, 0.8)", "borderColor": "rgba(255, 206, 86, 1)", "borderWidth": 1, "data": [1.75, 1.38, 1.25, 1.12, 0.92], "meta": {"avg_levels": [14.0, 11.0, 10.0, 9.0, 11.0], "runs": [1, 2, 1, 1, 1]}}, {"label": "水闸行动", "backgroundColor": "rgba(75, 192, 192, 0.8)", "borderColor": "rgba(75, 192, 192, 1)", "borderWidth": 1, "data": [1.62, 1.38, 1.25, 1.25, 1.58], "meta": {"avg_levels": [13.0, 11.0, 10.0, 10.0, 9.5], "runs": [1, 2, 1, 1, 2]}}, {"label": "圣焰隐修院", "backgroundColor": "rgba(153, 102, 255, 0.8)", "borderColor": "rgba(153, 102, 255, 1)", "borderWidth": 1, "data": [1.62, 1.31, 1.25, 1.25, 1.58], "meta": {"avg_levels": [13.0, 10.5, 10.0, 10.0, 9.5], "runs": [1, 2, 1, 1, 2]}}, {"label": "塔扎维什: 索·莉亚的宏图", "backgroundColor": "rgba(255, 159, 64, 0.8)", "borderColor": "rgba(255, 159, 64, 1)", "borderWidth": 1, "data": [1.62, 1.44, 1.38, 1.38, 1.42], "meta": {"avg_levels": [13.0, 11.5, 11.0, 11.0, 8.5], "runs": [1, 2, 1, 1, 2]}}, {"label": "塔扎维什: 琳彩天街", "backgroundColor": "rgba(199, 199, 199, 0.8)", "borderColor": "rgba(199, 199, 199, 1)", "borderWidth": 1, "data": [1.62, 1.25, 1.25, 1.25, 0.92], "meta": {"avg_levels": [13.0, 10.0, 10.0, 10.0, 11.0], "runs": [1, 2, 1, 1, 1]}}, {"label": "破晨号", "backgroundColor": "rgba(83, 102, 255, 0.8)", "borderColor": "rgba(83, 102, 255, 1)", "borderWidth": 1, "data": [1.62, 1.31, 1.38, 1.38, 0.83], "meta": {"avg_levels": [13.0, 10.5, 11.0, 11.0, 10.0], "runs": [1, 2, 1, 1, 1]}}]}, "player_character_dungeon_stats": {"吴工": [{"character": "体育老师", "class": "战士", "server": "通灵学院", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 8.0, "timed_runs": 0, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 7.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 9.0, "timed_runs": 1, "total_runs": 1}}}, {"character": "黑魔仙豹哥", "class": "死亡骑士", "server": "死亡之翼", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}}}], "段总": [{"character": "生锈的斩牛刀", "class": "盗贼", "server": "伊森利恩", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 12.0, "timed_runs": 1, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 14.0, "timed_runs": 0, "total_runs": 1}, "水闸行动": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}}}], "舒总": [{"character": "Fountine", "class": "法师", "server": "图拉扬", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 10.0, "timed_runs": 0, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}}}], "统皇": [{"character": "本间芽衣芓", "class": "战士", "server": "斯坦索姆", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 9.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}}}], "蔡圣": [{"character": "莱恩弗尔特", "class": "猎人", "server": "神圣之歌", "dungeon_stats": {"奥尔达尼生态圆顶": {"avg_level": 6.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 6.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 9.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 7.0, "timed_runs": 0, "total_runs": 1}}}, {"character": "亚里欧斯", "class": "恶魔猎手", "server": "神圣之歌", "dungeon_stats": {"艾拉-卡拉，回响之城": {"avg_level": 10.0, "timed_runs": 0, "total_runs": 1}, "奥尔达尼生态圆顶": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "赎罪大厅": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "水闸行动": {"avg_level": 13.0, "timed_runs": 1, "total_runs": 1}, "圣焰隐修院": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 索·莉亚的宏图": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}, "塔扎维什: 琳彩天街": {"avg_level": 11.0, "timed_runs": 1, "total_runs": 1}, "破晨号": {"avg_level": 10.0, "timed_runs": 1, "total_runs": 1}}}]}};

// 搜索与排序
(function initSummaryTableHelpers() {
    const table = document.getElementById('summaryTable');
    if (!table) return;
    const input = document.getElementById('summarySearch');
    const clearBtn = document.getElementById('clearSearch');
    const hideUntimedSummaryRowsCheckbox = document.getElementById('hideUntimedSummaryRows'); // 新增

    function normalizeText(s) { return (s || '').toString().toLowerCase(); }

    function filterSummaryRows() {
        const q = normalizeText(input.value);
        const hideUntimed = hideUntimedSummaryRowsCheckbox ? hideUntimedSummaryRowsCheckbox.checked : false;
        const rows = table.tBodies[0].rows;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const cells = Array.from(row.cells).map(td => normalizeText(td.textContent));

            // 搜索过滤
            const searchOk = q === '' || cells.some(txt => txt.includes(q));

            // 隐藏无限时记录过滤 (针对 summaryTable)
            let untimedOk = true;
            if (hideUntimed) { // 如果选中，则隐藏无记录
                // 从第三个单元格开始（跳过玩家和角色名），检查是否有非"-"的层数记录
                const dungeonLevels = Array.from(row.cells).slice(2); // 获取副本层数单元格
                const hasTimedRun = dungeonLevels.some(cell => {
                    const levelText = cell.textContent.trim();
                    return levelText !== '-' && levelText !== '';
                });
                untimedOk = hasTimedRun; // 如果没有限时记录，则 untimedOk 为 false，隐藏
            }
            
            row.style.display = (searchOk && untimedOk) ? '' : 'none';
        }
    }

    if (input) input.addEventListener('input', filterSummaryRows);
    if (clearBtn) clearBtn.addEventListener('click', () => { input.value = ''; filterSummaryRows(); input.focus(); });
    if (hideUntimedSummaryRowsCheckbox) hideUntimedSummaryRowsCheckbox.addEventListener('change', filterSummaryRows); // 新增事件监听
    
    // 页面加载时立即执行一次过滤，以应用默认状态
    filterSummaryRows();

    function parseLevel(text) {
        if (!text || text === '-') return Number.NEGATIVE_INFINITY;
        const n = parseInt(text.replace('+', ''));
        return isNaN(n) ? Number.NEGATIVE_INFINITY : n;
    }
    function sortTable(colIndex, type, asc) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows).filter(r => r.style.display !== 'none');
        const getVal = (row) => {
            const txt = row.cells[colIndex]?.textContent?.trim() || '';
            if (type === 'level') return parseLevel(txt);
            if (!isNaN(parseFloat(txt)) && isFinite(txt)) return parseFloat(txt);
            return txt.toLowerCase();
        };
        rows.sort((a,b) => { const va=getVal(a), vb=getVal(b); if (va<vb) return asc?-1:1; if (va>vb) return asc?1:-1; return 0; });
        rows.forEach(r => tbody.appendChild(r));
    }
    const headCells = table.tHead.rows[0].cells;
    let sortState = {};
    Array.from(headCells).forEach((th, i) => {
        if (!th.classList.contains('sortable')) return;
        th.addEventListener('click', () => {
            const type = th.getAttribute('data-type') || 'text';
            const prev = sortState[i] || false;
            const nextAsc = !prev;
            sortState = { [i]: nextAsc };
            sortTable(i, type, nextAsc);
            Array.from(headCells).forEach(h => h.removeAttribute('data-sort'));
            th.setAttribute('data-sort', nextAsc ? 'asc' : 'desc');
        });
    });
})();

// 等级分布图
// 等级分布图
const levelCtx = document.getElementById('levelChart').getContext('2d');
const levelLabels = chartsData.level_distribution.labels;
const levelData = chartsData.level_distribution.data;
const layerColorMap = chartsData.LAYER_COLOR_MAP;

// 根据层数获取颜色
const levelBackgroundColors = levelLabels.map(label => {
    const level = parseInt(label.replace('+', ''));
    return `#${layerColorMap[level] || '888888'}`; // 默认灰色
});
const levelBorderColors = levelBackgroundColors.map(color => color); // 边框颜色与背景色相同

// 检查是否为手机设备
function isMobile() {
    return window.innerWidth <= 768;
}

// 根据设备类型设置字体大小
const axisFontSize = isMobile() ? 10 : 16;

new Chart(levelCtx, {
    type: 'bar',
    data: {
        labels: levelLabels,
        datasets: [{
            label: '数量',
            data: levelData,
            backgroundColor: levelBackgroundColors,
            borderColor: levelBorderColors,
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: axisFontSize // 根据设备设置Y轴字体
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: axisFontSize, // 根据设备设置X轴字体
                        maxRotation: 45, // 在手机端允许标签旋转
                        minRotation: 0
                    }
                }
            }
        }
    }
});

// 副本表现图 (组合图：柱状图为平均等级，折线图为限时率)
const dungeonCtx = document.getElementById('dungeonChart').getContext('2d');
const dungeonLabels = chartsData.dungeon_performance.labels; // 简称
const dungeonFullNames = chartsData.dungeon_performance.full_names; // 全称
const dungeonAvgLevels = chartsData.dungeon_performance.avg_levels;
const dungeonTimedRates = chartsData.dungeon_performance.timed_rates;
const dungeonColorMap = chartsData.DUNGEON_COLOR_MAP;

// 根据副本全称获取颜色
const dungeonBackgroundColors = dungeonFullNames.map(fullName => {
    return dungeonColorMap[fullName] || 'rgba(120, 120, 120, 0.8)'; // 默认灰色
});
const dungeonBorderColors = dungeonBackgroundColors.map(color => color.replace('0.8)', '1)')); // 边框颜色使用不透明版本

// 设置字体大小
const dungeonAxisFontSize = isMobile() ? 10 : 16;
const dungeonLegendFontSize = isMobile() ? 12 : 16;

new Chart(dungeonCtx, {
    type: 'bar', // 主类型为柱状图
    data: {
        labels: dungeonLabels,
        datasets: [{
            type: 'bar', // 平均等级 - 柱状图
            label: '平均等级',
            data: dungeonAvgLevels,
            backgroundColor: dungeonBackgroundColors,
            borderColor: dungeonBorderColors,
            borderWidth: 1,
            yAxisID: 'y-avg-level'
        }, {
            type: 'line', // 通关率 - 折线图
            label: '通关率 (%)',
            data: dungeonTimedRates,
            fill: false,
            borderColor: 'rgba(255, 99, 132, 1)', // 使用一个鲜明的红色作为折线颜色
            tension: 0.1,
            yAxisID: 'y-completion-rate'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: {
                        size: dungeonLegendFontSize // 根据设备设置图例字体
                    }
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                titleFont: {
                    size: dungeonLegendFontSize // 根据设备设置tooltip标题字体
                },
                bodyFont: {
                    size: dungeonLegendFontSize // 根据设备设置tooltip内容字体
                },
                callbacks: {
                    title: function(tooltipItems) {
                        // 获取当前副本的简称
                        const shortName = tooltipItems[0].label;
                        // 从 chartsData 中获取全称映射
                        const fullNameMap = chartsData.DUNGEON_FULL_NAME_MAP;
                        // 查找全称
                        const fullName = fullNameMap[shortName] || shortName;
                        return fullName; // 显示全称
                    },
                    label: function(tooltipItem) {
                        let label = tooltipItem.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (tooltipItem.parsed.y !== null) {
                            label += tooltipItem.parsed.y;
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            'y-avg-level': {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: {
                    display: true,
                    text: '平均等级',
                    font: {
                        size: dungeonAxisFontSize // 根据设备设置Y轴标题字体
                    }
                },
                ticks: {
                    font: {
                        size: dungeonAxisFontSize // 根据设备设置Y轴刻度字体
                    }
                }
            },
            'y-completion-rate': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: '通关率 (%)',
                    font: {
                        size: dungeonAxisFontSize // 根据设备设置Y轴标题字体
                    }
                },
                ticks: {
                    font: {
                        size: dungeonAxisFontSize // 根据设备设置Y轴刻度字体
                    },
                },
                grid: {
                    drawOnChartArea: false, // 只绘制左侧Y轴的网格线
                },
            },
            x: {
                ticks: {
                    font: {
                        size: dungeonAxisFontSize, // 根据设备设置X轴刻度字体
                        maxRotation: 45, // 在手机端允许标签旋转
                        minRotation: 0
                    }
                }
            }
        }
    }
});

// 职业平均层数图
const classCtx = document.getElementById('classChart').getContext('2d');
const classLabels = Object.keys(chartsData.class_performance);
const classLevels = classLabels.map(c => chartsData.class_performance[c].avg_level);
const classColors = classLabels.map(c => chartsData.class_performance[c].color || 'rgba(120,120,120,0.8)');

// 设置字体大小
const classAxisFontSize = isMobile() ? 10 : 16;

new Chart(classCtx, {
    type: 'bar',
    data: {
        labels: classLabels,
        datasets: [{
            label: '平均层数',
            data: classLevels,
            backgroundColor: classColors,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: {
                        size: classAxisFontSize // 根据设备设置Y轴字体
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: classAxisFontSize, // 根据设备设置X轴字体
                        maxRotation: 45, // 在手机端允许标签旋转
                        minRotation: 0
                    }
                }
            }
        }
    }
});

// 角色统计动态渲染、排序和过滤
(function initCharacterStats() {
    const characterStatsData = chartsData.character_stats_data;
    const characterStatsContainer = document.getElementById('characterStatsCards');
    const hideEmptyCharsCheckbox = document.getElementById('hideEmptyChars');
    const characterSortBySelect = document.getElementById('characterSortBy');

    let currentDisplayMetric = 'avg_level'; // 默认显示平均等级

    function updateDisplayMetric(sortByValue) {
        if (sortByValue.startsWith('avg_level')) {
            currentDisplayMetric = 'avg_level';
        } else if (sortByValue.startsWith('completion_rate')) {
            currentDisplayMetric = 'completion_rate';
        } else if (sortByValue.startsWith('timed_runs_rate')) { // 新增的限时完成率排序
            currentDisplayMetric = 'timed_runs_rate';
        }
        // 如果是其他排序（职业、角色名），则不改变 currentDisplayMetric
    }

    function renderCharacterStats(data) {
        console.log("Rendering character stats with data:", data);
        characterStatsContainer.innerHTML = ''; // 清空现有卡片
        if (data.length === 0) {
            characterStatsContainer.innerHTML = '<p style="text-align: center; width: 100%; color: #7f8c8d;">没有符合条件的记录。</p>';
            return;
        }
        data.forEach(stat => {
            const classColor = chartsData.CLASS_COLOR_MAP[stat.class] || '888888'; // 从chartsData获取颜色，默认灰色
            
            let displayLabel = '';
            let displayValue = '';

            if (currentDisplayMetric === 'avg_level') {
                displayLabel = '平均等级';
                displayValue = typeof stat.avg_level === 'number' ? stat.avg_level.toFixed(2) : 'N/A';
            } else if (currentDisplayMetric === 'completion_rate') {
                displayLabel = '通关率';
                displayValue = typeof stat.completion_rate === 'number' ? stat.completion_rate.toFixed(2) : 'N/A' + '%';
            } else if (currentDisplayMetric === 'timed_runs_rate') { // 新增的限时完成率
                displayLabel = '限时完成率';
                displayValue = typeof stat.timed_runs_rate === 'number' ? stat.timed_runs_rate.toFixed(2) : 'N/A' + '%';
            } else {
                // 默认显示平均等级，以防万一
                displayLabel = '平均等级';
                displayValue = typeof stat.avg_level === 'number' ? stat.avg_level.toFixed(2) : 'N/A';
            }

            const cardHtml = `
                <div class="character-stat-card">
                    <div class="character-card-header" style="border-left-color: #${classColor};">
                        <div class="character-info">
                            <div class="character-name">${stat.character}</div>
                            <div class="character-server">${stat.server}</div>
                        </div>
                        <div class="character-class ${'class-' + stat.class}" style="color: #${classColor};">${stat.class}</div>
                    </div>
                    <div class="character-card-content">
                        <div class="character-stat-row">
                            <div class="character-stat-item">
                                <span class="character-stat-label">${displayLabel}</span>
                                <span class="character-stat-value">${displayValue}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            characterStatsContainer.insertAdjacentHTML('beforeend', cardHtml);
        });
    }

    function applyFiltersAndSort() {
        let filteredData = [...characterStatsData];
        console.log("Original characterStatsData:", characterStatsData);

        // 过滤
        if (hideEmptyCharsCheckbox.checked) {
            filteredData = filteredData.filter(char => {
                // 隐藏无记录角色：total_runs 为 0，或者 avg_level 为 0/NaN
                const hasMeaningfulRecords = (!isNaN(char.total_runs) && char.total_runs > 0) &&
                                             (!isNaN(char.avg_level) && char.avg_level > 0);
                console.log(`Filtering ${char.character}: total_runs=${char.total_runs}, avg_level=${char.avg_level}, hasMeaningfulRecords=${hasMeaningfulRecords}`);
                return hasMeaningfulRecords;
            });
            console.log("Filtered data (hide empty):", filteredData);
        }

        // 排序
        const sortBy = characterSortBySelect.value;
        updateDisplayMetric(sortBy); // 根据排序选项更新显示指标

        filteredData.sort((a, b) => {
            switch (sortBy) {
                case 'avg_level_desc': return b.avg_level - a.avg_level;
                case 'avg_level_asc': return a.avg_level - b.avg_level;
                case 'completion_rate_desc': return b.completion_rate - a.completion_rate;
                case 'completion_rate_asc': return a.completion_rate - b.completion_rate;
                case 'timed_runs_rate_desc': return b.timed_runs_rate - a.timed_runs_rate; // 新增排序逻辑
                case 'timed_runs_rate_asc': return a.timed_runs_rate - b.timed_runs_rate; // 新增排序逻辑
                case 'class_asc': return a.class.localeCompare(b.class);
                case 'class_desc': return b.class.localeCompare(a.class);
                case 'character_name_asc': return a.character.localeCompare(b.character);
                case 'character_name_desc': return b.character.localeCompare(a.character);
                default: return 0;
            }
        });
        console.log("Sorted data:", filteredData);

        renderCharacterStats(filteredData);
    }

    // 添加事件监听器
    hideEmptyCharsCheckbox.addEventListener('change', applyFiltersAndSort);
    characterSortBySelect.addEventListener('change', applyFiltersAndSort);

    // 初始渲染
    applyFiltersAndSort();
})();

// 玩家统计图表
(function initPlayerChart() {
    const playerCtx = document.getElementById('playerChart').getContext('2d');
    const playerChartData = chartsData.player_stats_data; // 现在 player_stats_data 包含 player_labels 和 datasets

    if (!playerChartData || !playerChartData.player_labels || playerChartData.player_labels.length === 0) {
        playerCtx.canvas.parentNode.innerHTML = '<p style="text-align: center; color: #7f8c8d;">暂无玩家统计数据。</p>';
        return;
    }

    // 检查是否为手机设备
    function isMobile() {
        return window.innerWidth <= 768;
    }

    // 找到最牛逼的玩家（平均等级最高） - 需要重新计算，因为数据结构变了
    // 假设 playerChartData.player_labels 已经按平均等级降序排序
    const playerLabels = playerChartData.player_labels;
    const datasets = playerChartData.datasets;

    // 计算每个玩家的总平均等级，用于皇冠标记
    const playerOverallAvgLevels = playerLabels.map((player, playerIndex) => {
        let totalLevelSum = 0;
        let totalRuns = 0;
        datasets.forEach(dataset => {
            const dungeonAvgLevel = dataset.meta.avg_levels[playerIndex];
            const dungeonRuns = dataset.meta.runs[playerIndex];
            if (dungeonRuns > 0) {
                totalLevelSum += dungeonAvgLevel * dungeonRuns;
                totalRuns += dungeonRuns;
            }
        });
        return totalRuns > 0 ? totalLevelSum / totalRuns : 0;
    });

    let bestPlayerIndex = -1;
    let maxAvgLevel = -1;
    playerOverallAvgLevels.forEach((avgLevel, index) => {
        if (avgLevel > maxAvgLevel) {
            maxAvgLevel = avgLevel;
            bestPlayerIndex = index;
        }
    });

    const finalPlayerLabels = playerLabels.map((label, index) => {
        if (index === bestPlayerIndex) {
            // 使用更大的皇冠emoji，并调整字体大小
            return '👑 ' + label; // 保持原样，因为Chart.js的label不支持HTML，直接改emoji字符
        }
        return label;
    });

    // 调整皇冠emoji的大小，通过修改y轴ticks的字体大小来影响
    // 由于Chart.js的label是绘制在canvas上的，不能直接用CSS控制emoji大小
    // 只能通过调整整个label的字体大小来间接影响
    // 考虑到用户要求"很大"，我们将y轴ticks的字体大小进一步增大
    const playerLabelFontSize = 18; // 进一步增大字体大小
    const playerLabelFontWeight = 'bold'; // 保持加粗

    // 在手机端，将多个数据集合并为单一数据集
    let finalDatasets = datasets;
    let chartOptions = {
        indexAxis: 'y', // 横向柱状图
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true, // 显示图例，因为有多个数据集（副本）
                position: 'top',
                labels: {
                    font: {
                        size: 14 // 增大副本名字字体
                    }
                }
            },
            tooltip: {
                enabled: false // 禁用tooltip
            }
        },
        scales: {
            x: {
                stacked: true, // X轴堆叠
                beginAtZero: true,
                title: {
                    display: true,
                    text: '平均等级贡献'
                }
            },
            y: {
                stacked: true, // Y轴堆叠
                title: {
                    display: false, // 删除Y轴标题
                    text: '玩家'
                },
                ticks: {
                    font: {
                        size: playerLabelFontSize, // 增大玩家名字字体
                        weight: playerLabelFontWeight // 加粗
                    }
                },
                barPercentage: 0.8, // 调整柱状条宽度占比，增加间距
                categoryPercentage: 0.9, // 调整类别间距占比
                // 尝试设置barThickness为'flex'，让Chart.js自动计算最佳宽度
                barThickness: 'flex',
                grid: {
                    offset: false // 确保网格线不偏移，可能影响柱子位置
                }
            }
        },
        onClick: (e) => {
            const activePoints = playerChartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (activePoints.length > 0) {
                const clickedDatasetIndex = activePoints[0].datasetIndex;
                const clickedElementIndex = activePoints[0].index;
                const playerName = playerChartInstance.data.labels[clickedElementIndex].replace('👑 ', ''); // 移除皇冠emoji

                showPlayerDetailModal(playerName);
            }
        }
    };

    if (isMobile()) {
        // 在手机端，合并所有数据集为一个单一数据集
        const combinedData = playerLabels.map((player, playerIndex) => {
            let totalLevel = 0;
            datasets.forEach(dataset => {
                totalLevel += dataset.data[playerIndex] || 0;
            });
            return totalLevel;
        });

        finalDatasets = [{
            label: '总平均等级',
            data: combinedData,
            backgroundColor: 'rgba(100, 149, 237, 0.6)', // 低饱和度且半透明的蓝色
            borderColor: 'rgba(100, 149, 237, 0.8)',
            borderWidth: 1,
            barPercentage: 0.6, // 调整柱状条宽度占比，避免太粗
            categoryPercentage: 0.8 // 调整类别间距占比
        }];

        // 在手机端修改图表选项
        chartOptions.plugins.legend.display = false; // 隐藏图例
        chartOptions.scales.x.stacked = false; // 不需要堆叠
        chartOptions.scales.y.stacked = false; // 不需要堆叠
        chartOptions.scales.x.title.text = '总平均等级'; // 修改标题
        
        // 在手机端调整Y轴的柱状条显示
        chartOptions.scales.y.barPercentage = 0.6; // 柱状条宽度占比
        chartOptions.scales.y.categoryPercentage = 0.8; // 类别间距占比
        chartOptions.scales.y.barThickness = 'flex'; // 让Chart.js自动计算最佳厚度
    }

    // 动态计算图表高度
    const numberOfPlayers = finalPlayerLabels.length;
    const barHeight = 25; // 每个柱状条的高度
    const paddingHeight = 100; // 顶部和底部以及轴标签的额外空间
    playerCtx.canvas.height = numberOfPlayers * barHeight + paddingHeight;

    const playerChartInstance = new Chart(playerCtx, {
        type: 'bar', // 柱状图
        data: {
            labels: finalPlayerLabels,
            datasets: finalDatasets
        },
        options: chartOptions
    });
})();

// 玩家详情弹窗逻辑
let playerDetailChartInstance = null; // 用于存储弹窗图表实例

function showPlayerDetailModal(playerName) {
    const modal = document.getElementById('playerDetailModal');
    const modalTitle = document.getElementById('modalTitle');
    const playerDetailChartCanvas = document.getElementById('playerDetailChart');
    const closeButton = document.querySelector('#playerDetailModal .close-button');

    modalTitle.textContent = `${playerName} 的角色副本统计`;
    modal.style.display = 'flex'; // Show the modal

    // 获取玩家的详细角色数据
    const playerCharactersData = chartsData.player_character_dungeon_stats[playerName];

    if (!playerCharactersData || playerCharactersData.length === 0) {
        playerDetailChartCanvas.parentNode.innerHTML = '<p style="text-align: center; color: #7f8c8d;">没有找到该玩家的角色副本数据。</p>';
        return;
    }

    // 聚合所有角色的副本数据
    const aggregatedDungeonStats = {}; // {dungeonName: {total_level_sum: X, total_runs: Y}}

    playerCharactersData.forEach(char => {
        for (const dungeonName in char.dungeon_stats) {
            const stats = char.dungeon_stats[dungeonName];
            if (!aggregatedDungeonStats[dungeonName]) {
                aggregatedDungeonStats[dungeonName] = { level_sum: 0, runs: 0 };
            }
            aggregatedDungeonStats[dungeonName].level_sum += (stats.avg_level * stats.total_runs);
            aggregatedDungeonStats[dungeonName].runs += stats.total_runs;
        }
    });

    // 准备 Chart.js 数据
    const dungeonLabels = [];
    const avgLevels = [];
    const backgroundColors = [];
    const borderColors = [];

    // 按照 DUNGEON_NAME_MAP 的顺序来显示副本，确保一致性
    const allDungeons = Object.values(chartsData.DUNGEON_FULL_NAME_MAP); // 获取所有副本全称

    allDungeons.forEach(dungeonFullName => {
        if (aggregatedDungeonStats[dungeonFullName] && aggregatedDungeonStats[dungeonFullName].runs > 0) {
            const avgLevel = aggregatedDungeonStats[dungeonFullName].level_sum / aggregatedDungeonStats[dungeonFullName].runs;
            const dungeonShortName = chartsData.DUNGEON_SHORT_NAME_MAP[dungeonFullName] || dungeonFullName; // 获取简称
            dungeonLabels.push(dungeonShortName); // 使用简称
            avgLevels.push(avgLevel.toFixed(1)); // 保留一位小数

            const color = chartsData.DUNGEON_COLOR_MAP[dungeonFullName] || 'rgba(120, 120, 120, 0.8)';
            backgroundColors.push(color);
            borderColors.push(color.replace('0.8)', '1)'));
        }
    });

    // 如果没有数据，显示提示
    if (dungeonLabels.length === 0) {
        playerDetailChartCanvas.parentNode.innerHTML = '<p style="text-align: center; color: #7f8c8d;">该玩家没有有效的副本记录。</p>';
        return;
    }

    // 销毁旧图表实例（如果存在）
    if (playerDetailChartInstance) {
        playerDetailChartInstance.destroy();
    }

    // 创建新图表
    playerDetailChartInstance = new Chart(playerDetailChartCanvas, {
        type: 'bar',
        data: {
            labels: dungeonLabels,
            datasets: [{
                label: '平均层数',
                data: avgLevels,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(tooltipItems) {
                            return tooltipItems[0].label; // 显示副本全称
                        },
                        label: function(tooltipItem) {
                            return `平均层数: ${tooltipItem.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '平均层数'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '副本'
                    }
                }
            }
        }
    });

    // 关闭弹窗事件监听
    closeButton.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
}

// AFK Player Logic
(function initAfkPlayerLogic() {
    const afkIcon = document.getElementById('afk-icon'); // Keep this for now, might be useful for other things
    const afkIconContainer = document.querySelector('.afk-icon-container'); // Get the container
    const afkPlayerModal = document.getElementById('afkPlayerModal');
    const afkCloseButton = document.getElementById('afkCloseButton');
    const afkPlayerListContainer = document.getElementById('afkPlayerList');
    const loveProgressBar = document.getElementById('loveProgressBar');
    const loveCountSpan = document.getElementById('loveCount');
    const emojiRainContainer = document.getElementById('emojiRainContainer');

    let afkPlayers = []; // Store identified AFK players as objects: {name: 'PlayerName', clicks: 0}
    let totalLoveProgress = 0; // Total clicks across all players
    let maxTotalLoveProgress = 0; // Max possible clicks (num_afk_players * 10)
    const MAX_CLICKS_PER_PLAYER = 10; // Each player needs 10 clicks
    let emojiRainActive = false; // Flag to track if emoji rain is active
    let emojiRainTimeoutId; // New variable to store the timeout ID for stopping rain

    // Function to identify AFK players
    function identifyAfkPlayers() {
        const allPlayers = {}; // {playerName: {total_runs: X, characters: [{...}]}}

        // Aggregate character data by player
        chartsData.character_stats_data.forEach(char => {
            if (!allPlayers[char.player]) {
                allPlayers[char.player] = {
                    total_runs: 0,
                    characters: []
                };
            }
            allPlayers[char.player].total_runs += char.total_runs;
            allPlayers[char.player].characters.push(char);
        });

        const identifiedAfkPlayers = [];
        for (const playerName in allPlayers) {
            const playerData = allPlayers[playerName];
            // An AFK player is one whose all characters have 0 total_runs
            if (playerData.total_runs === 0) {
                identifiedAfkPlayers.push({ name: playerName, clicks: 0 }); // Store as object with clicks
            }
        }
        return identifiedAfkPlayers;
    }

    // Function to render AFK players in the modal
    function renderAfkPlayers() {
        afkPlayerListContainer.innerHTML = ''; // Clear previous list
        if (afkPlayers.length === 0) {
            afkPlayerListContainer.innerHTML = '<p>恭喜！所有玩家都在线！</p>';
            return;
        }

        afkPlayers.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.classList.add('afk-player-item'); // Use a new class for styling
            playerDiv.dataset.playerName = player.name; // Store player name for click handling

            const playerNameSpan = document.createElement('span');
            playerNameSpan.classList.add('afk-player-name');
            playerNameSpan.textContent = player.name;

            const playerProgressBarContainer = document.createElement('div');
            playerProgressBarContainer.classList.add('player-progress-bar-container');
            const playerProgressBar = document.createElement('div');
            playerProgressBar.classList.add('player-progress-bar');
            playerProgressBar.style.width = `${(player.clicks / MAX_CLICKS_PER_PLAYER) * 100}%`;
            playerProgressBarContainer.appendChild(playerProgressBar);

            const playerClicksSpan = document.createElement('span');
            playerClicksSpan.classList.add('player-clicks-count');
            playerClicksSpan.textContent = `${player.clicks}/${MAX_CLICKS_PER_PLAYER}`;

            playerDiv.appendChild(playerNameSpan);
            playerDiv.appendChild(playerProgressBarContainer);
            playerDiv.appendChild(playerClicksSpan);

            playerDiv.addEventListener('click', (event) => {
                handlePlayerClick(event, player.name); // Pass player name to handler
            });
            afkPlayerListContainer.appendChild(playerDiv);
        });
    }

    // Handle player name click
    function handlePlayerClick(event, clickedPlayerName) {
        const player = afkPlayers.find(p => p.name === clickedPlayerName);
        if (!player || player.clicks >= MAX_CLICKS_PER_PLAYER) {
            return; // Player not found or already maxed out
        }

        const x = event.clientX;
        const y = event.clientY;

        // Create and animate the emoji
        const emoji = document.createElement('span');
        emoji.classList.add('emoji-fade-out');
        emoji.textContent = '💋'; // Kiss emoji
        emoji.style.left = `${x - 20}px`; // Adjust position to center emoji
        emoji.style.top = `${y - 20}px`;
        document.body.appendChild(emoji);

        emoji.addEventListener('animationend', () => {
            emoji.remove();
        });

        // Update individual player's love progress
        player.clicks++;
        totalLoveProgress = afkPlayers.reduce((sum, p) => sum + p.clicks, 0); // Recalculate total progress

        // Update individual player's UI
        const playerDiv = afkPlayerListContainer.querySelector(`[data-player-name="${player.name}"]`);
        if (playerDiv) {
            const playerProgressBar = playerDiv.querySelector('.player-progress-bar');
            const playerClicksSpan = playerDiv.querySelector('.player-clicks-count');
            playerProgressBar.style.width = `${(player.clicks / MAX_CLICKS_PER_PLAYER) * 100}%`;
            playerClicksSpan.textContent = `${player.clicks}/${MAX_CLICKS_PER_PLAYER}`;
        }

        // Update overall love progress bar
        loveProgressBar.style.width = `${(totalLoveProgress / maxTotalLoveProgress) * 100}%`;
        loveCountSpan.textContent = `${totalLoveProgress}/${maxTotalLoveProgress}`;

        if (totalLoveProgress >= maxTotalLoveProgress && !emojiRainActive) {
            startEmojiRain();
            // Optionally disable further clicks until rain stops or modal closes
            afkPlayerListContainer.querySelectorAll('.afk-player-item').forEach(el => el.style.pointerEvents = 'none');
        }
    }

    // Start emoji rain effect
    let emojiRainInterval;
    function startEmojiRain() {
        emojiRainActive = true;
        const emojis = ['💖', '✨', '🌟', '🌈', '💕', '💞', '💓', '💗', '💘', '💝']; // Emojis to fall
        let duration = 5000; // 5 seconds
        let startTime = Date.now();

        // Clear any existing rain
        stopEmojiRain(); // This call is correct to prevent multiple rains

        emojiRainInterval = setInterval(() => {
            // This condition is inside setInterval, meaning it checks every 100ms
            if (Date.now() - startTime > duration) {
                stopEmojiRain(); // If this condition is met, it stops the *current* rain.
                return;
            }
            const emoji = document.createElement('span');
            emoji.classList.add('falling-emoji');
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.left = `${Math.random() * 100}vw`;
            emoji.style.animationDuration = `${Math.random() * 2 + 3}s`; // 3-5 seconds
            emoji.style.animationDelay = `${Math.random() * 0.5}s`;
            emojiRainContainer.appendChild(emoji);

            emoji.addEventListener('animationend', () => {
                emoji.remove();
            });
        }, 100);

        // Set a timeout to stop the rain after the specified duration
        emojiRainTimeoutId = setTimeout(() => {
            stopEmojiRain();
        }, duration);
    }

    function stopEmojiRain() {
        clearInterval(emojiRainInterval);
        clearTimeout(emojiRainTimeoutId); // Clear the timeout as well
        emojiRainContainer.innerHTML = ''; // Clear all falling emojis
        emojiRainActive = false;
        afkPlayerListContainer.querySelectorAll('.afk-player-name').forEach(el => el.style.pointerEvents = 'auto');
    }

    // Event listeners
    if (afkIconContainer) {
        afkIconContainer.addEventListener('click', () => {
            afkPlayers = identifyAfkPlayers();
            maxTotalLoveProgress = afkPlayers.length * MAX_CLICKS_PER_PLAYER; // Calculate max total progress
            totalLoveProgress = afkPlayers.reduce((sum, p) => sum + p.clicks, 0); // Initialize total progress

            renderAfkPlayers();
            afkPlayerModal.style.display = 'flex';
            
            // Update overall progress bar on open
            loveProgressBar.style.width = `${(totalLoveProgress / maxTotalLoveProgress) * 100}%`;
            loveCountSpan.textContent = `${totalLoveProgress}/${maxTotalLoveProgress}`;
        });
    }

    if (afkCloseButton) {
        afkCloseButton.addEventListener('click', () => {
            afkPlayerModal.style.display = 'none';
            // Do NOT reset progress on close, keep it for next open
            // Do NOT stop emoji rain here
        });
    }

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target === afkPlayerModal) {
            afkPlayerModal.style.display = 'none';
            // Do NOT reset progress on close, keep it for next open
            // Do NOT stop emoji rain here
        }
    });
})();

// 全屏表格查看功能
(function initFullscreenTable() {
    const fullscreenBtn = document.getElementById('fullscreenTableBtn');
    const fullscreenModal = document.getElementById('fullscreenTableModal');
    const closeBtn = fullscreenModal ? fullscreenModal.querySelector('.close-button') : null;
    const originalTable = document.getElementById('summaryTable');
    
    if (!fullscreenBtn || !fullscreenModal || !originalTable) {
        console.warn('Fullscreen table elements not found');
        return;
    }

    // 克隆表格到全屏弹窗
    function cloneTableToFullscreen() {
        const modalBody = fullscreenModal.querySelector('.modal-body');
        if (!modalBody) return;

        // 清空现有内容
        modalBody.innerHTML = '';

        // 创建新的表格包装器
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';

        // 克隆原始表格
        const clonedTable = originalTable.cloneNode(true);
        clonedTable.id = 'fullscreenSummaryTable'; // 给新表格一个不同的ID

        // 应用全屏模式下的样式
        clonedTable.classList.add('fullscreen-table');

        tableWrapper.appendChild(clonedTable);
        modalBody.appendChild(tableWrapper);

        // 重新初始化表格的排序功能
        initFullscreenTableSorting(clonedTable);
        
        // 重新初始化表格的搜索功能
        initFullscreenTableSearch(clonedTable);
    }

    // 初始化全屏表格的排序功能
    function initFullscreenTableSorting(table) {
        const headCells = table.tHead.rows[0].cells;
        let sortState = {};

        Array.from(headCells).forEach((th, i) => {
            if (!th.classList.contains('sortable')) return;
            
            th.addEventListener('click', () => {
                const type = th.getAttribute('data-type') || 'text';
                const prev = sortState[i] || false;
                const nextAsc = !prev;
                sortState = { [i]: nextAsc };
                sortFullscreenTable(table, i, type, nextAsc);
                
                Array.from(headCells).forEach(h => h.removeAttribute('data-sort'));
                th.setAttribute('data-sort', nextAsc ? 'asc' : 'desc');
            });
        });
    }

    // 全屏表格排序函数
    function sortFullscreenTable(table, colIndex, type, asc) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        
        const parseLevel = (text) => {
            if (!text || text === '-') return Number.NEGATIVE_INFINITY;
            const n = parseInt(text.replace('+', ''));
            return isNaN(n) ? Number.NEGATIVE_INFINITY : n;
        };
        
        const getVal = (row) => {
            const txt = row.cells[colIndex]?.textContent?.trim() || '';
            if (type === 'level') return parseLevel(txt);
            if (!isNaN(parseFloat(txt)) && isFinite(txt)) return parseFloat(txt);
            return txt.toLowerCase();
        };
        
        rows.sort((a,b) => { 
            const va = getVal(a), vb = getVal(b); 
            if (va < vb) return asc ? -1 : 1; 
            if (va > vb) return asc ? 1 : -1; 
            return 0; 
        });
        
        rows.forEach(r => tbody.appendChild(r));
    }

    // 初始化全屏表格的搜索功能
    function initFullscreenTableSearch(table) {
        // 获取主页面的“隐藏无限时记录”复选框
        const hideUntimedSummaryRowsCheckbox = document.getElementById('hideUntimedSummaryRows');

        // 创建搜索工具栏
        const toolbar = document.createElement('div');
        toolbar.className = 'table-toolbar';
        toolbar.style.cssText = 'padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;';

        const actions = document.createElement('div');
        actions.className = 'toolbar-actions';

        const searchInput = document.createElement('input');
        searchInput.type = 'search';
        searchInput.className = 'search-input';
        searchInput.placeholder = '搜索玩家/角色/副本...';
        searchInput.style.cssText = 'width: 200px; margin-right: 10px;';

        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn';
        clearBtn.textContent = '清除';
        clearBtn.style.cssText = 'padding: 6px 12px;';

        actions.appendChild(searchInput);
        actions.appendChild(clearBtn);
        toolbar.appendChild(actions);

        // 将工具栏插入到表格前面
        const tableWrapper = table.parentNode;
        tableWrapper.parentNode.insertBefore(toolbar, tableWrapper);

        // 搜索功能
        function filterRows() {
            const q = searchInput.value.toLowerCase().trim();
            // 获取“隐藏无限时记录”的状态
            const hideUntimed = hideUntimedSummaryRowsCheckbox ? hideUntimedSummaryRowsCheckbox.checked : false;
            const rows = table.tBodies[0].rows;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = Array.from(row.cells);
                const text = cells.map(td => td.textContent.toLowerCase()).join(' ');

                // 搜索过滤
                const searchOk = q === '' || text.includes(q);

                // 隐藏无限时记录过滤 (针对 summaryTable)
                let untimedOk = true;
                if (hideUntimed) { // 如果选中，则隐藏无记录
                    // 从第三个单元格开始（跳过玩家和角色名），检查是否有非"-"的层数记录
                    const dungeonLevels = Array.from(row.cells).slice(2); // 获取副本层数单元格
                    const hasTimedRun = dungeonLevels.some(cell => {
                        const levelText = cell.textContent.trim();
                        return levelText !== '-' && levelText !== '';
                    });
                    untimedOk = hasTimedRun; // 如果没有限时记录，则 untimedOk 为 false，隐藏
                }
                
                row.style.display = (searchOk && untimedOk) ? '' : 'none';
            }
        }

        searchInput.addEventListener('input', filterRows);
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            filterRows();
            searchInput.focus();
        });
    }

    // 检查是否为手机设备
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // 检查是否为横屏模式
    function isLandscape() {
        return window.innerWidth > window.innerHeight;
    }

    // 打开全屏弹窗
    function openFullscreenModal() {
        // 克隆表格
        cloneTableToFullscreen();


        // 显示弹窗
        fullscreenModal.style.display = 'block';
        
        // 防止背景滚动
        document.body.style.overflow = 'hidden';
    }

    // 关闭全屏弹窗
    function closeFullscreenModal() {
        fullscreenModal.style.display = 'none';
        // 恢复背景滚动
        document.body.style.overflow = '';
    }

    // 事件监听器
    fullscreenBtn.addEventListener('click', openFullscreenModal);
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeFullscreenModal);
    }

    // 点击弹窗外部关闭
    fullscreenModal.addEventListener('click', (event) => {
        if (event.target === fullscreenModal) {
            closeFullscreenModal();
        }
    });

    // ESC键关闭弹窗
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && fullscreenModal.style.display === 'block') {
            closeFullscreenModal();
        }
    });

    // 监听屏幕方向变化（手机端）
    window.addEventListener('orientationchange', () => {
        if (fullscreenModal.style.display === 'block' && isMobile()) {
            // 重新克隆表格以适应新的屏幕方向
            setTimeout(() => {
                cloneTableToFullscreen();
            }, 100); // 等待方向变化完成
        }
    });
})();

    </script>
</body>
</html>
